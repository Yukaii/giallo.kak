name: Build and Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
          - os: macos-latest
            target: aarch64-apple-darwin

    steps:
      - uses: actions/checkout@v5

      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Test
        run: cargo test --release --target ${{ matrix.target }}

      - name: Package
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/giallo-kak dist/
          cd dist
          tar czf ../giallo-kak-${{ matrix.target }}.tar.gz giallo-kak

      - uses: actions/upload-artifact@v4
        with:
          name: giallo-kak-${{ matrix.target }}
          path: |
            dist/giallo-kak
            giallo-kak-*.tar.gz
          if-no-files-found: error

  prerelease:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v5

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: giallo-kak-*

      - id: sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 0
          delete_tag_pattern: prerelease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: prerelease
          name: Prerelease (${{ steps.sha.outputs.sha }})
          body: |
            This is a prerelease build from commit ${{ steps.sha.outputs.sha }}.
            
            These binaries are automatically built and may contain unstable features.
            For stable releases, see the [releases page](https://github.com/Yukaii/giallo.kak/releases).
          files: artifacts/giallo-kak-*/*.tar.gz
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-crate-prerelease:
    needs: [build, prerelease]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v5

      - uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Get current version and SHA
        id: version
        run: |
          CURRENT_VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          SHA=$(git rev-parse --short HEAD)
          PRERELEASE_VERSION="${CURRENT_VERSION}-prerelease.${SHA}"
          echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
          echo "prerelease_version=${PRERELEASE_VERSION}" >> $GITHUB_OUTPUT
          echo "Publishing prerelease version: ${PRERELEASE_VERSION}"

      - name: Update version for prerelease
        run: |
          sed -i "s/^version = \"${{ steps.version.outputs.current_version }}\"/version = \"${{ steps.version.outputs.prerelease_version }}\"/" Cargo.toml
          cat Cargo.toml | grep version

      - name: Verify package
        run: cargo package --allow-dirty --no-verify

      - name: Publish prerelease to crates.io
        run: cargo publish --allow-dirty
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v5

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: giallo-kak-*

      - uses: softprops/action-gh-release@v1
        with:
          files: artifacts/giallo-kak-*/*.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-crate:
    needs: [build, release]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v5

      - uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Verify package
        run: cargo package --allow-dirty --no-verify

      - name: Publish to crates.io
        run: cargo publish --allow-dirty
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # Performance testing with PR comments
  performance-report:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      contents: read

    steps:
      - uses: actions/checkout@v5

      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: x86_64-unknown-linux-gnu

      - uses: Swatinem/rust-cache@v2

      - name: Install Kakoune
        run: sudo apt-get update && sudo apt-get install -y kakoune bc

      - name: Build for performance tests
        run: cargo build --release --target x86_64-unknown-linux-gnu

      - name: Run performance tests
        id: perf
        run: |
          set +e  # Don't exit on error, capture test results
          
          # Run performance tests and capture output
          cargo test --release --target x86_64-unknown-linux-gnu --test performance 2>&1 | tee perf_output.txt
          TEST_EXIT_CODE=$?
          
          # Extract metrics from output - Rust tests output "X file (N lines...): T.ms"
          # Small file: matches "Small file (100 lines..." - specifically Rust small file
          SMALL_TIME=$(grep -oP 'Small file \(100[^)]*\): \K[\d.]+(?=ms)' perf_output.txt | head -1 || echo "N/A")
          # Medium file: matches "Medium file (1000 lines..." - specifically Rust medium file  
          MEDIUM_TIME=$(grep -oP 'Medium file \(1000[^)]*\): \K[\d.]+(?=ms)' perf_output.txt | head -1 || echo "N/A")
          # Large file: matches "Large file (10000 lines..." - specifically Rust large file
          LARGE_TIME=$(grep -oP 'Large file \(10000[^)]*\): \K[\d.]+(?=ms)' perf_output.txt | head -1 || echo "N/A")
          # Memory: get from Rust small file test
          MEMORY=$(grep -oP 'Small file \(100[^)]*\): [\d.]+ms, memory delta: \K[\d.]+(?=MB)' perf_output.txt | head -1 || echo "N/A")
          
          # Check against thresholds
          SMALL_THRESHOLD=300
          MEDIUM_THRESHOLD=1000
          LARGE_THRESHOLD=5000
          
          REGRESSION=false
          REGRESSION_MSG=""
          
          if [[ "$SMALL_TIME" != "N/A" ]] && (( $(echo "$SMALL_TIME > $SMALL_THRESHOLD" | bc -l 2>/dev/null || echo 0) )); then
            REGRESSION=true
            REGRESSION_MSG="${REGRESSION_MSG}\n- Small file: ${SMALL_TIME}ms (threshold: ${SMALL_THRESHOLD}ms)"
          fi
          
          if [[ "$MEDIUM_TIME" != "N/A" ]] && (( $(echo "$MEDIUM_TIME > $MEDIUM_THRESHOLD" | bc -l 2>/dev/null || echo 0) )); then
            REGRESSION=true
            REGRESSION_MSG="${REGRESSION_MSG}\n- Medium file: ${MEDIUM_TIME}ms (threshold: ${MEDIUM_THRESHOLD}ms)"
          fi
          
          if [[ "$LARGE_TIME" != "N/A" ]] && (( $(echo "$LARGE_TIME > $LARGE_THRESHOLD" | bc -l 2>/dev/null || echo 0) )); then
            REGRESSION=true
            REGRESSION_MSG="${REGRESSION_MSG}\n- Large file: ${LARGE_TIME}ms (threshold: ${LARGE_THRESHOLD}ms)"
          fi
          
          echo "small_time=$SMALL_TIME" >> $GITHUB_OUTPUT
          echo "medium_time=$MEDIUM_TIME" >> $GITHUB_OUTPUT
          echo "large_time=$LARGE_TIME" >> $GITHUB_OUTPUT
          echo "memory=$MEMORY" >> $GITHUB_OUTPUT
          echo "regression=$REGRESSION" >> $GITHUB_OUTPUT
          echo "regression_msg=$REGRESSION_MSG" >> $GITHUB_OUTPUT
          
          exit $TEST_EXIT_CODE
        continue-on-error: true

      - name: Post Performance Report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SMALL_TIME: ${{ steps.perf.outputs.small_time }}
          MEDIUM_TIME: ${{ steps.perf.outputs.medium_time }}
          LARGE_TIME: ${{ steps.perf.outputs.large_time }}
          MEMORY: ${{ steps.perf.outputs.memory }}
          REGRESSION: ${{ steps.perf.outputs.regression }}
          REGRESSION_MSG: ${{ steps.perf.outputs.regression_msg }}
        run: |
          # Determine status emoji
          if [[ "$REGRESSION" == "true" ]]; then
            STATUS="⚠️ Performance regression detected"
          else
            STATUS="✅ Performance within acceptable thresholds"
          fi
          
          # Build the comment body
          cat > comment.md << EOF
          ## Performance Test Results
          
          | Metric | Value | Threshold |
          |--------|-------|-----------|
          | Small file (100 lines) | ${SMALL_TIME}ms | 300ms |
          | Medium file (1000 lines) | ${MEDIUM_TIME}ms | 1000ms |
          | Large file (10000 lines) | ${LARGE_TIME}ms | 5000ms |
          | Memory delta | ${MEMORY}MB | 150MB |
          
          **Status:** ${STATUS}
          EOF
          
          if [[ "$REGRESSION" == "true" ]]; then
            cat >> comment.md << EOF
          
          ### ⚠️ Regressions Detected:
          ${REGRESSION_MSG}
          
          Please investigate these performance changes.
          EOF
          fi
          
          cat >> comment.md << EOF
          
          ---
          *Tested on: ubuntu-latest, x86_64*
          EOF
          
          # Check for existing performance report comment
          EXISTING_COMMENT=$(gh pr view "$PR_NUMBER" --json comments --jq '.comments[] | select(.body | contains("## Performance Test Results")) | .id' | head -1)
          
          if [[ -n "$EXISTING_COMMENT" ]]; then
            # Update existing comment
            gh pr comment "$PR_NUMBER" --edit "$EXISTING_COMMENT" --body-file comment.md
          else
            # Create new comment
            gh pr comment "$PR_NUMBER" --body-file comment.md
          fi
        continue-on-error: true

      - name: Upload Performance Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-report-pr-${{ github.event.pull_request.number }}
          path: perf_output.txt
          if-no-files-found: ignore
