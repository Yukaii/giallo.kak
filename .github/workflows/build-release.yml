name: Build and Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin

    steps:
      - uses: actions/checkout@v5

      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Test
        run: cargo test --release --target ${{ matrix.target }}

      - name: Package
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/giallo-kak dist/
          cd dist
          tar czf ../giallo-kak-${{ matrix.target }}.tar.gz giallo-kak

      - uses: actions/upload-artifact@v4
        with:
          name: giallo-kak-${{ matrix.target }}
          path: |
            dist/giallo-kak
            giallo-kak-*.tar.gz
          if-no-files-found: error

  prerelease:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v5

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: giallo-kak-*

      - id: sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 0
          delete_tag_pattern: prerelease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: prerelease
          name: Prerelease (${{ steps.sha.outputs.sha }})
          body: |
            This is a prerelease build from commit ${{ steps.sha.outputs.sha }}.
            
            These binaries are automatically built and may contain unstable features.
            For stable releases, see the [releases page](https://github.com/Yukaii/giallo.kak/releases).
          files: artifacts/giallo-kak-*/*.tar.gz
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-crate-prerelease:
    needs: [build, prerelease]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v5

      - uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Get current version and SHA
        id: version
        run: |
          CURRENT_VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          SHA=$(git rev-parse --short HEAD)
          PRERELEASE_VERSION="${CURRENT_VERSION}-prerelease.${SHA}"
          echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
          echo "prerelease_version=${PRERELEASE_VERSION}" >> $GITHUB_OUTPUT
          echo "Publishing prerelease version: ${PRERELEASE_VERSION}"

      - name: Update version for prerelease
        run: |
          sed -i "s/^version = \"${{ steps.version.outputs.current_version }}\"/version = \"${{ steps.version.outputs.prerelease_version }}\"/" Cargo.toml
          cat Cargo.toml | grep version

      - name: Verify package
        run: cargo package --allow-dirty --no-verify

      - name: Publish prerelease to crates.io
        run: cargo publish --allow-dirty
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v5

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: giallo-kak-*

      - uses: softprops/action-gh-release@v1
        with:
          files: artifacts/giallo-kak-*/*.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-crate:
    needs: [build, release]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v5

      - uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Verify package
        run: cargo package --allow-dirty --no-verify

      - name: Publish to crates.io
        run: cargo publish --allow-dirty
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
